# ASP.NET Core
# Build and test ASP.NET Core projects targeting .NET Core.
# Add steps that run tests, create a NuGet package, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/dotnet-core

trigger:
  - '*'
  
variables:
  buildConfiguration: 'Release'

stages:
  - stage: 'Build'
    displayName: 'Build the web application'
    jobs: 
    - job: 'Build'
      displayName: 'Build job'
      pool:
        vmImage: 'ubuntu-latest'

      steps:
      - task: DotNetCoreCLI@2
        displayName: 'Restore project dependencies'
        inputs:
          command: 'restore'
          projects: '**/*.csproj'

      - task: DotNetCoreCLI@2
        displayName: 'Build the project - Release'
        inputs:
          command: 'build'
          arguments: '--no-restore --configuration Release'
          projects: '**/*.csproj'

      - task: DotNetCoreCLI@2
        displayName: 'Run unit tests - $(buildConfiguration)'
        inputs:
          command: 'test'
          arguments: '--no-build --configuration $(buildConfiguration)'
          publishTestResults: true
          projects: '**/*.Test.csproj'

      - task: DotNetCoreCLI@2
        displayName: 'Publish the project - Release'
        inputs:
          command: 'publish'
          projects: '**/*.csproj'
          publishWebProjects: false
          arguments: '--no-build --configuration Release --output $(Build.ArtifactStagingDirectory)/Release'
          zipAfterPublish: true

      - task: PublishBuildArtifacts@1
        displayName: 'Publish Artifact: drop'
        condition: succeeded()
  
  - stage: 'Deploy'
    displayName: 'Deploy the web application'
    dependsOn: Build
    jobs:
    - deployment: Deploy
      pool:
        vmImage: 'ubuntu-latest'
      environment: dev
      strategy:
        runOnce:
          deploy:
            steps:
            - download: current
              artifact: drop
            
            - task: AzurePowerShell@5
              inputs:
                azureSubscription: 'DevConf2020Azure'
                ScriptType: 'InlineScript'
                Inline: 'New-AzResourceGroupDeployment -ResourceGroupName DevConf2020 -TemplateUri https://raw.githubusercontent.com/whosenbocus/DevConf2020/release-pipeline-createAZResource/DevConfAzARM.json -TemplateParameterUri https://raw.githubusercontent.com/whosenbocus/DevConf2020/release-pipeline-createAZResource/DevConfAzARM.parameters.json'
                azurePowerShellVersion: 'LatestVersion'
                
            - task: AzureWebApp@1
              inputs:
                azureSubscription: 'DevConf2020Azure'
                appType: 'webApp'
                appName: 'DevConf2020'
                package: '$(Agent.WorkFolder)/**/DevConf2020.zip'
                deploymentMethod: 'auto'